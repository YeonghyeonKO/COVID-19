df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
View(num)
# segmented poisson에서 적합되지 않는 국가들 list
country2 <- c("China", "Japan", "Nepal", "Puerto_Rico", "Tunisia", "New_Zealand",
"Burkina_Faso", "Comoros", "Equatorial_Guinea", "Botswana", "Sri_Lanka")
`%notin%` <- purrr::negate(`%in%`)
num <- df %>%
group_by(country) %>%
mutate(total = cumsum(cases)) %>%
filter(total > 0, country %notin% country2) %>%
summarise(count = n())
n = 171
for (k in num$country[172:199]){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
for (j in seq(from = 11, by = 2, length.out = 2)){
n <- 0
coef_Poi <- data.frame(matrix(NA, ncol = 6, nrow = nrow(num)))
coef_seg_Poi <- data.frame(matrix(NA, ncol = 14, nrow = nrow(num)))
rownames(coef_Poi) <- num$country
rownames(coef_seg_Poi) <- num$country
assign(paste0("cases_smoothing"), pracma::movavg(df$cases, j, type = "s"))
df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country[172:199]){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
for (j in seq(from = 11, by = 2, length.out = 2)){
n <- 0
coef_Poi <- data.frame(matrix(NA, ncol = 6, nrow = nrow(num)))
coef_seg_Poi <- data.frame(matrix(NA, ncol = 14, nrow = nrow(num)))
rownames(coef_Poi) <- num$country
rownames(coef_seg_Poi) <- num$country
assign(paste0("cases_smoothing"), pracma::movavg(df$cases, j, type = "s"))
df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
set.seed(1234)
for (j in seq(from = 11, by = 2, length.out = 2)){
n <- 0
coef_Poi <- data.frame(matrix(NA, ncol = 6, nrow = nrow(num)))
coef_seg_Poi <- data.frame(matrix(NA, ncol = 14, nrow = nrow(num)))
rownames(coef_Poi) <- num$country
rownames(coef_seg_Poi) <- num$country
assign(paste0("cases_smoothing"), pracma::movavg(df$cases, j, type = "s"))
df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
View(coef_seg_Poi)
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
for (j in seq(from = 13, by = 2, length.out = 1)){
n <- 0
coef_Poi <- data.frame(matrix(NA, ncol = 6, nrow = nrow(num)))
coef_seg_Poi <- data.frame(matrix(NA, ncol = 14, nrow = nrow(num)))
rownames(coef_Poi) <- num$country
rownames(coef_seg_Poi) <- num$country
assign(paste0("cases_smoothing"), pracma::movavg(df$cases, j, type = "s"))
df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
set.seed(1234)
for (j in seq(from = 13, by = 2, length.out = 1)){
n <- 0
coef_Poi <- data.frame(matrix(NA, ncol = 6, nrow = nrow(num)))
coef_seg_Poi <- data.frame(matrix(NA, ncol = 14, nrow = nrow(num)))
rownames(coef_Poi) <- num$country
rownames(coef_seg_Poi) <- num$country
assign(paste0("cases_smoothing"), pracma::movavg(df$cases, j, type = "s"))
df[5] <- cases_smoothing
colnames(df)[5] = paste0("cases_smoothing")
for (k in num$country){
n <- n + 1
days <- num$count[n]
data_s <- df %>%
filter(country == k) %>%
mutate(total = cumsum(cases)) %>%
filter(total >= 1) %>%
mutate(Days_after_first_Case = 1:days) %>%
filter(date < "2020-07-11")
if (data_s$total[days] < 300){
next
}
# Poisson Model
fit <- glm(cases ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
fit_s <- glm(cases_smoothing ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
#fit_s <- glm(as.numeric(unlist(data_s[(j+7)/2])) ~ log(Days_after_first_Case) + Days_after_first_Case, data = data_s, family = poisson)
coef_Poi[k, ] <- c(fit$coefficients, fit_s$coefficients)
# Segmented Model
tryCatch(
expr = {
seg_fit <- segmented(fit, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi <- round(seg_fit$psi[2])
fit1 <- glm(cases[1:psi] ~ log(Days_after_first_Case[1:psi]) + Days_after_first_Case[1:psi],
data = data_s, family = poisson)
fit2 <- glm(cases[psi+1:num$count[n]] ~ log(Days_after_first_Case[psi+1:num$count[n]]) + Days_after_first_Case[psi+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 1:7] <- c(summary(fit1)$coefficients[,1], summary(fit2)$coefficients[,1], psi)
},
error = function(e){
next
},
finally = {
NULL
}
)
tryCatch(
expr = {
seg_fit_s <- segmented(fit_s, seg.Z = ~ log(Days_after_first_Case) + Days_after_first_Case, npsi = 1)
psi_s <- round(seg_fit_s$psi[2])
fit1_s <- glm(cases[1:psi_s] ~ log(Days_after_first_Case[1:psi_s]) + Days_after_first_Case[1:psi_s],
data = data_s, family = poisson)
fit2_s <- glm(cases[psi_s+1:num$count[n]] ~ log(Days_after_first_Case[psi_s+1:num$count[n]]) + Days_after_first_Case[psi_s+1:num$count[n]],
data = data_s, family = poisson)
coef_seg_Poi[k, 8:14] <- c(summary(fit1_s)$coefficients[,1], summary(fit2_s)$coefficients[,1], psi_s)
},
error = function(e){
next
},
finally = {
NULL
}
)
}
colnames(coef_Poi) <- c(names(fit$coefficients), paste0(names(fit$coefficients), "_smoothing"))
colnames(coef_seg_Poi) <- c("(Intercept)_1", "log(Days_after_first_Case)_1", "Days_after_first_Case_1",
"(Intercept)_2", "log(Days_after_first_Case)_2", "Days_after_first_Case_2",	"psi",
"(Intercept)_1_s", "log(Days_after_first_Case)_1_s", "Days_after_first_Case_1_s",
"(Intercept)_2_s", "log(Days_after_first_Case)_2_s", "Days_after_first_Case_2_s", "psi_s")
########################
#### .csv 파일 저장 ####
########################
write.csv(coef_Poi, paste0(result_path, "Coef_Poi_", j, ".csv"), row.names = T)
write.csv(coef_seg_Poi, paste0(result_path, "Coef_seg_Poi_", j, ".csv"), row.names = T)
}
